<%
const defaults = { date: formatDate(), effectiveDate: formatDate() };
const data = Object.assign({}, defaults, formData || {});
// ---- Additional Interest aggregator (1-up fields + array fallback)
const aiBlocks = [];
function pushAI(name, addr, city, state, zip, types) {
  if (!name && !addr && !city && !state && !zip) return;
  aiBlocks.push({
    name: name || "",
    addressLine: join([addr, city, state, zip]) || "",
    types: types || {}
  });
}
// 1..5 (v1)
pushAI(data.ai_name_1, data.ai_address_1, data.ai_city_1, data.ai_state_1, data.ai_zip_1,
       { addl: data.ai_additional_insured, loss: data.ai_loss_payee, mort: data.ai_mortgagee, lien: data.ai_lienholder });
pushAI(data.ai_name_2, data.ai_address_2, data.ai_city_2, data.ai_state_2, data.ai_zip_2,
       { addl: data.ai_additional_insured_2, loss: data.ai_loss_payee_2, mort: data.ai_mortgagee_2, lien: data.ai_lienholder_2 });
pushAI(data.ai_name_3, data.ai_address_3, data.ai_city_3, data.ai_state_3, data.ai_zip_3,
       { addl: data.ai_additional_insured_3, loss: data.ai_loss_payee_3, mort: data.ai_mortgagee_3, lien: data.ai_lienholder_3 });
pushAI(data.ai_name_4, data.ai_address_4, data.ai_city_4, data.ai_state_4, data.ai_zip_4,
       { addl: data.ai_additional_insured_4, loss: data.ai_loss_payee_4, mort: data.ai_mortgagee_4, lien: data.ai_lienholder_4 });
pushAI(data.ai_name_5, data.ai_address_5, data.ai_city_5, data.ai_state_5, data.ai_zip_5,
       { addl: data.ai_additional_insured_5, loss: data.ai_loss_payee_5, mort: data.ai_mortgagee_5, lien: data.ai_lienholder_5 });
// array (v2)
if (Array.isArray(data.additional_interests)) {
  data.additional_interests.forEach(it => {
    pushAI(it.name, it.address, it.city, it.state, it.zip,
      { addl: it.additional_insured, loss: it.loss_payee, mort: it.mortgagee, lien: it.lienholder });
  });
}
%>
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ACORD 126 – Commercial General Liability</title>
  <!-- shared stylesheet injected by server -->
  <style><%= styles %></style>
</head>
<body>

  <div class="page">
    <div class="headerbar">
      <div class="acord">ACORD</div>
      <div class="title">COMMERCIAL GENERAL LIABILITY SECTION</div>
      <div class="formno">126</div>
    </div>

    <!-- Applicant -->
    <div class="subbar">APPLICANT</div>
    <div class="block">
      <div class="row">
        <div class="cell label w25">NAME</div>
        <div class="cell w75 wrap"><%= data.applicant_name || data.named_insured || "" %></div>
      </div>
      <div class="row">
        <div class="cell label w25">PREMISES</div>
        <div class="cell w75 wrap"><%= join([data.premise_address, data.premise_city, data.premise_state, data.premise_zip]) %></div>
      </div>
    </div>

    <!-- Exposures -->
    <div class="subbar">EXPOSURES</div>
    <div class="block">
      <div class="row">
        <div class="cell label w25">TOTAL SALES</div>
        <div class="cell w25 right"><%= moneyUSD(data.total_sales) %></div>
        <div class="cell label w25">ALCOHOL SALES</div>
        <div class="cell w25 right"><%= moneyUSD(data.alcohol_sales) %></div>
      </div>
      <div class="row no-break">
        <div class="cell label w25">SQUARE FOOTAGE</div>
        <div class="cell w25 right"><%= data.square_footage || "" %></div>
        <div class="cell label w25">OCCUPANCY</div>
        <div class="cell w25"><%= data.occupancy || data.max_occupancy || "" %></div>
      </div>
    </div>

    <!-- Additional Interest(s) -->
    <div class="subbar">ADDITIONAL INTEREST</div>
    <div class="block">
      <% if (aiBlocks.length) { %>
        <% aiBlocks.forEach((ai, idx) => { %>
          <div class="row">
            <div class="cell label w20">NAME</div>
            <div class="cell w40 wrap"><%= ai.name %></div>
            <div class="cell label w10">TYPE</div>
            <div class="cell w30">
              <span class="check"><%= isYes(ai.types.addl) ? "✓" : "" %></span> Addl Insured
              <span class="check"><%= isYes(ai.types.loss) ? "✓" : "" %></span> Loss Payee
              <span class="check"><%= isYes(ai.types.mort) ? "✓" : "" %></span> Mortgagee
              <span class="check"><%= isYes(ai.types.lien) ? "✓" : "" %></span> Lienholder
            </div>
          </div>
          <div class="row" style="<%= idx < aiBlocks.length-1 ? 'border-bottom:1px solid #bbb' : '' %>">
            <div class="cell label w20">ADDRESS</div>
            <div class="cell w80 wrap small"><%= ai.addressLine %></div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="row"><div class="cell w100" style="color:#666;">No additional interests provided.</div></div>
      <% } %>
    </div>

    <!-- Remarks -->
    <div class="subbar">REMARKS</div>
    <div class="block">
      <div class="row no-break">
        <div class="cell w100 wrap small"><%= data.remarks || "" %></div>
      </div>
    </div>
  </div>

  <!-- Signature / Legal (new page) -->
  <div class="page pagebreak">
    <div class="headerbar">
      <div class="acord">ACORD</div>
      <div class="title">COMMERCIAL GENERAL LIABILITY SECTION</div>
      <div class="formno">126</div>
    </div>

    <div class="subbar">SIGNATURE</div>
    <div class="block">
      <div class="row">
        <div class="cell label w30">APPLICANT’S SIGNATURE</div>
        <div class="cell w70">&nbsp;</div>
      </div>
      <div class="row">
        <div class="cell label w30">TITLE</div>
        <div class="cell w30">&nbsp;</div>
        <div class="cell label w20">DATE</div>
        <div class="cell w20"><%= data.date %></div>
      </div>
    </div>

    <div class="subbar">LEGAL NOTICE</div>
    <div class="block">
      <div class="row">
        <div class="cell w100">
          <div class="legal small wrap">
            The undersigned authorized representative of the applicant declares that all statements are true and complete…
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>

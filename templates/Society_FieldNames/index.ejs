<%
/* ===== Helpers & sane defaults (ACORD/Society stack) ===== */
const defaults = {
  // Masthead/branding
  programTitle: "Special Program Supplemental Application",
  programSubtitle: "(Restaurant, Bar, EZ Prep, Brewpub, Brewery & Winery)",
  accent: "#C0171D", // Society red

  // Agency block
  agencyName: "All Access Insurance dba Commercial Insurance Direct, LLC",
  agencyCode: "70025M",
  agentName: "Rick Cline",
  agentEmail: "quote@barinsurancedirect.com",
  agentPhone: "303-932-1700",

  // App meta
  date: "",             // prefer this if posted
  effective_date: "",   // fallback for date

  // Header fields
  applicant_name: "",
  premise_address: "",   // full street+city+state+zip if you post it that way

  // Operations status & experience
  open_60_days: "",                 // yes/no
  open_60_days_details: "",
  ownership_experience: "",         // yes/no
  ownership_experience_details: "",
  closing_time: "",
  square_footage: "",
  num_employees: "",
  fine_dining: "",                  // yes/no
  counter_service: "",              // yes/no

  // Alcohol & receipts
  alcohol_manufactured: "",         // yes/no
  percent_consumed: "",             // yes/no (>25% on-premise?)
  food_sales: "",
  alcohol_sales: "",
  total_sales: "",
  Percent_Alcohol: "",

  // Cooking levels / cannabis / UL300
  cooking_level_full: "",           // yes/no
  cooking_level_limited: "",
  cooking_level_non: "",
  infused_with_cannabis: "",        // yes/no
  solid_fuel: "",                   // yes/no  (single question; reused)
  non_UL300: "",                    // yes/no

  // Entertainment / Recreational
  entertainment_other: "",          // yes/no
  entertainment_details: "",
  recreational_activites: "",       // yes/no (spelling per sheet)
  recreational_details: "",

  // Security
  security_present: "",             // yes/no
  background_checks: "",            // may come via ComboBox22
  security_armed: "",               // may come via ComboBox23
  security_trained: "",             // may come via ComboBox24

  // Delivery & auto
  delivery_offered: "",             // yes/no
  del_insured_autos: "",            // may come via ComboBox13
  del_employee_autos: "",           // may come via ComboBox14
  del_third_party: "",              // may come via ComboBox15
  del_sales_owned_emp: "",          // currency; may come via delivery_sales_amount
  del_pct_over_20: "",              // may come via ComboBox16
  del_pct_explain: "",              // may come via TextField12
  del_radius_gt5: "",               // may come via ComboBox17
  del_radius_explain: "",           // may come via TextField11
  del_after_10pm: "",               // may come via ComboBox18
  del_after_10pm_explain: "",       // may come via TextField13

  // Shuttle
  shuttle_services: "",             // may come via ComboBox19
  shuttle_explanation: "",

  // Liquor
  liquor_lapse: "",                 // yes/no (violations last 3 yrs)
  liquor_claims: "",                // details

  // Smoker / Grill (final spec; keyed off solid_fuel)
  professionally_installed: "",      // yes/no
  cleaned_scraped_weekly: "",        // yes/no
  vent_cleaned_monthly: "",          // yes/no
  ashes_removed_daily: "",           // yes/no
  storage_10_feet: "",               // yes/no (fuel/pellets/wood > 10' from unit?)
  hood_system_ul300: "",             // yes/no (drives UL/Hood/Spark = Yes when true)
  smoker_ul300_protected: "",        // optional direct yes/no
  smoker_hood_protected: "",         // optional direct yes/no
  smoker_spark_arrestor: "",         // optional direct yes/no
  smoker_ash_metal_container: "",    // yes/no
  smoker_notes: "",                  // long text

  // Remarks
  remarks: "",

  // Legacy / carry-overs for compatibility (optional posts)
  ComboBox22: "", ComboBox23: "", ComboBox24: "", // security trio
  ComboBox13: "", ComboBox14: "", ComboBox15: "", // delivery trio
  ComboBox16: "", ComboBox17: "", ComboBox18: "", ComboBox19: "",
  TextField11: "", TextField12: "", TextField13: "", // delivery explainers
  delivery_sales_amount: "" // alt to del_sales_owned_emp
};

const data = Object.assign({}, defaults, (typeof formData === "object" && formData) || {});

// ===== Small helpers (no new helper functions beyond these) =====
const yeslike = (v) => ["y","yes","true","1","on","checked"].includes(String(v||"").trim().toLowerCase());
const yn = (v) => (v===""||v==null) ? "" : (yeslike(v) ? "Y" : "N");
const money = (v) => {
  if (v==null || v==="") return "";
  const n = Number(String(v).replace(/[^0-9.-]/g,""));
  if (isNaN(n)) return String(v);
  return n.toLocaleString("en-US", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
};
const formatDate = (d) => {
  if (!d) return "";
  const dt = new Date(d); if (isNaN(dt)) return String(d);
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  const yy = dt.getFullYear();
  return `${mm}/${dd}/${yy}`;
};
const prefer = (a,b) => (a!=="" && a!==undefined) ? a : b;

// Date fix: no currency fallbacks
const dateShown = data.date || data.effective_date || "";

// Security aliasing
const background_checks = prefer(data.background_checks, data.ComboBox22);
const security_armed   = prefer(data.security_armed,   data.ComboBox23);
const security_trained = prefer(data.security_trained, data.ComboBox24);

// Delivery aliasing
const del_insured_autos   = prefer(data.del_insured_autos,   data.ComboBox13);
const del_employee_autos  = prefer(data.del_employee_autos,  data.ComboBox14);
const del_third_party     = prefer(data.del_third_party,     data.ComboBox15);
const del_pct_over_20     = prefer(data.del_pct_over_20,     data.ComboBox16);
const del_radius_gt5      = prefer(data.del_radius_gt5,      data.ComboBox17);
const del_after_10pm      = prefer(data.del_after_10pm,      data.ComboBox18);
const shuttle_services    = prefer(data.shuttle_services,    data.ComboBox19);
const del_sales_owned_emp = prefer(data.del_sales_owned_emp, data.delivery_sales_amount);

// Smoker auto-fills from “hood_system_ul300” (simple in-template vars)
const hoodSystemYes = yeslike(data.hood_system_ul300 || "");
const smoker_ul300_yn = yn( yeslike(data.smoker_ul300_protected) || hoodSystemYes );
const smoker_hood_yn  = yn( yeslike(data.smoker_hood_protected)  || hoodSystemYes );
const smoker_spark_yn = yn( yeslike(data.smoker_spark_arrestor)  || hoodSystemYes );
%>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Society SPS-1 — Special Program Supplemental</title>
  <style>
    @media print { @page { margin: .25in; size: letter; } .page{ page-break-after: always } .page:last-child{ page-break-after:auto } }
    *{ box-sizing:border-box; margin:0; padding:0 }
    body{ font-family: Arial, sans-serif; font-size: 8pt; color:#000 }
    .page{ width:100%; min-height:10.5in; padding:.125in; border:1px solid #ccc; position:relative; background:#fff }
    .headerbar{ display:flex; align-items:center; height:42px; border:2px solid #000; margin-bottom:2px; }
    .headerbar .brand{ background:<%= defaults.accent %>; color:#fff; font-weight:bold; font-size:14pt; width:120px; display:flex; align-items:center; justify-content:center; height:100% }
    .headerbar .title{ flex:1; text-align:center; font-weight:bold; line-height:1.15 }
    .headerbar .title .line1{ font-size:12pt }
    .headerbar .title .line2{ font-size:9pt; color:<%= defaults.accent %> }
    .subbar{ background:<%= defaults.accent %>; color:#fff; font-weight:bold; font-size:9pt; padding:3px 8px; margin:2px 0 }
    .block{ border:1px solid #000; margin-bottom:2px }
    .row{ display:flex; border-bottom:1px solid #000; min-height:18px }
    .row:last-child{ border-bottom:none }
    .cell{ border-right:1px solid #000; padding:1px 3px; display:flex; align-items:center; overflow-wrap:break-word }
    .cell:last-child{ border-right:none }
    .cell.label{ background:#f7f7f7; font-weight:bold; font-size:6.7pt }
    .cell.center{ justify-content:center; text-align:center }
    .cell.right{ justify-content:flex-end; text-align:right }
    .cell.wrap{ flex-wrap:wrap; align-items:flex-start }
    .cell.small{ font-size:7pt }
    .w5{width:5%}.w8{width:8%}.w10{width:10%}.w12{width:12%}.w15{width:15%}.w18{width:18%}.w20{width:20%}.w22{width:22%}.w25{width:25%}.w30{width:30%}.w35{width:35%}.w40{width:40%}.w45{width:45%}.w50{width:50%}.w55{width:55%}.w60{width:60%}.w65{width:65%}.w70{width:70%}.w75{width:75%}.w80{width:80%}.w85{width:85%}.w90{width:90%}.w100{width:100%}
    .check{ display:inline-block; width:10px; height:10px; border:1px solid #000; text-align:center; line-height:8px; font-size:8pt; margin:0 6px 0 2px; vertical-align:middle }
    .footnote{ position:absolute; bottom:.125in; left:.125in; right:.125in; font-size:6pt; border-top:1px solid #000; padding-top:2px; text-align:center }
    @media screen{ .page{ margin-bottom:20px; box-shadow:0 0 10px rgba(0,0,0,.1) } }
  </style>
</head>
<body>

<!-- ====================== PAGE 1 ====================== -->
<div class="page">
  <div class="headerbar">
    <div class="brand">SPS-1</div>
    <div class="title">
      <div class="line1"><%= defaults.programTitle %></div>
      <div class="line2"><%= defaults.programSubtitle %></div>
    </div>
  </div>

  <!-- APPLICANT / ADDRESS / DATE -->
  <div class="subbar">APPLICANT</div>
  <div class="block">
    <div class="row">
      <div class="cell label w20">APPLICANT NAME</div>
      <div class="cell w50 wrap"><%= data.applicant_name %></div>
      <div class="cell label w10">DATE</div>
      <div class="cell w20"><%= formatDate(dateShown) %></div>
    </div>
    <div class="row">
  <div class="cell label w20">PREMISES ADDRESS</div>
  <div class="cell w80 wrap">
    <%
      const cityState = [data.premise_city, data.premise_state].filter(Boolean).join(", ");
      const fullPremise = [data.premise_address, cityState, data.premise_zip]
        .map(v => (v ?? "").toString().trim())
        .filter(v => v.length)
        .join(" ");
    %>
    <%= fullPremise %>
  </div>
</div>

  <!-- 1–3 OPEN/EXPERIENCE/CLOSING -->
  <div class="subbar">OPERATIONS STATUS & EXPERIENCE</div>
  <div class="block">
    <div class="row">
      <div class="cell label w55">1. OPEN FOR BUSINESS NOW OR WITHIN 60 DAYS?</div>
      <div class="cell w5 center"><%= yn(data.open_60_days) %></div>
      <div class="cell label w15">IF NO, EXPLAIN</div>
      <div class="cell w25 wrap"><%= data.open_60_days_details %></div>
    </div>
    <div class="row">
      <div class="cell label w55">2. AT LEAST 3 YEARS RESTAURANT/BAR OWNERSHIP IN LAST 5 YEARS?</div>
      <div class="cell w5 center"><%= yn(data.ownership_experience) %></div>
      <div class="cell label w15">IF NO, PRIOR EXPERIENCE</div>
      <div class="cell w25 wrap"><%= data.ownership_experience_details %></div>
    </div>
    <div class="row">
      <div class="cell label w30">3. CLOSING TIME</div>
      <div class="cell w20"><%= data.closing_time %></div>
      <div class="cell label w25">SQUARE FOOTAGE</div>
      <div class="cell w25 right"><%= money(data.square_footage) %></div>
    </div>
    <div class="row">
      <div class="cell label w30">NUMBER OF EMPLOYEES</div>
      <div class="cell w20 right"><%= money(data.num_employees) %></div>
      <div class="cell label w25">FINE DINING?</div>
      <div class="cell w10 center"><%= yn(data.fine_dining) %></div>
      <div class="cell label w10">COUNTER SERV.?</div>
      <div class="cell w5 center"><%= yn(data.counter_service) %></div>
    </div>
  </div>

  <!-- 8–13 ALCOHOL & COOKING -->
  <div class="subbar">ALCOHOL & COOKING</div>
  <div class="block">
    <div class="row">
      <div class="cell label w35">8. MANUFACTURE ALCOHOL?</div>
      <div class="cell w10 center"><%= yn(data.alcohol_manufactured) %></div>
      <div class="cell label w40">IF YES, &gt; 25% FOR ON-PREMISE?</div>
      <div class="cell w15 center"><%= yn(data.percent_consumed) %></div>
    </div>
    <div class="row">
      <div class="cell label w20">FOOD SALES</div>
      <div class="cell w15 right">$<%= money(data.food_sales) %></div>
      <div class="cell label w20">ALCOHOL SALES</div>
      <div class="cell w15 right">$<%= money(data.alcohol_sales) %></div>
      <div class="cell label w15">TOTAL SALES</div>
      <div class="cell w15 right">$<%= money(data.total_sales) %></div>
    </div>
    <div class="row">
      <div class="cell label w30">% ALCOHOL</div>
      <div class="cell w20 right"><%= data.Percent_Alcohol %>%</div>
      <div class="cell label w25">10. LEVEL OF COOKING</div>
      <div class="cell w25 small">
        <span class="check"><%= yeslike(data.cooking_level_full) ? "X" : "" %></span> Full
        <span class="check"><%= yeslike(data.cooking_level_limited) ? "X" : "" %></span> Limited
        <span class="check"><%= yeslike(data.cooking_level_non) ? "X" : "" %></span> None
      </div>
    </div>
    <div class="row">
      <div class="cell label w35">11. INFUSE PRODUCTS WITH CANNABIS?</div>
      <div class="cell w10 center"><%= yn(data.infused_with_cannabis) %></div>
      <div class="cell label w30">12. ANY SOLID FUEL WITHIN 10 FT?</div>
      <div class="cell w10 center"><%= yn(data.solid_fuel) %></div>
      <div class="cell label w15">13. ANY NON-UL300 SURFACES?</div>
      <div class="cell w10 center"><%= yn(data.non_UL300) %></div>
    </div>
  </div>

  <!-- SMOKER / GRILL — FINAL SPEC (driven by solid_fuel) -->
  <div class="subbar">SMOKER / GRILL — COOKING DETAILS</div>
  <div class="block">
    <div class="row">
      <div class="cell label w45">SOLID FUEL (SMOKER / GRILL) WITHIN 10 FT?</div>
      <div class="cell w10 center"><%= yn(data.solid_fuel) %></div>
      <div class="cell label w25">UNIT PROFESSIONALLY INSTALLED?</div>
      <div class="cell w20 center"><%= yn(data.professionally_installed) %></div>
    </div>

    <div class="row">
      <div class="cell label w25">REGULARLY MAINTAINED</div>
      <div class="cell w75 small">
        <span class="check"><%= yeslike(data.cleaned_scraped_weekly) ? "X" : "" %></span> Scraped Weekly
        <span class="check"><%= yeslike(data.vent_cleaned_monthly) ? "X" : "" %></span> Vent/Exhaust Inspected/Cleaned Monthly
        <span class="check"><%= yeslike(data.ashes_removed_daily) ? "X" : "" %></span> Ashes Removed Daily
      </div>
    </div>

    <div class="row">
      <div class="cell label w60">IS FUEL / PELLETS / WOOD MORE THAN 10' FROM UNIT?</div>
      <div class="cell w10 center"><%= yn(data.storage_10_feet) %></div>
      <div class="cell label w20">ASH IN METAL CONTAINER W/ LID?</div>
      <div class="cell w10 center"><%= yn(data.smoker_ash_metal_container) %></div>
    </div>

    <div class="row">
      <div class="cell label w45">UL / SUPPRESSION OVER COOKING?</div>
      <div class="cell w10 center"><%= smoker_ul300_yn %></div>
      <div class="cell label w35">HOOD / DUCT PROTECTION?</div>
      <div class="cell w10 center"><%= smoker_hood_yn %></div>
    </div>

    <div class="row">
      <div class="cell label w45">SPARK ARRESTOR FITTED?</div>
      <div class="cell w10 center"><%= smoker_spark_yn %></div>
      <div class="cell w45"></div>
    </div>

    <div class="row">
      <div class="cell label w20">NOTES</div>
      <div class="cell w80 wrap" style="min-height:48px;"><%= data.smoker_notes %></div>
    </div>
  </div>

  <!-- 14–16 ENTERTAINMENT / ACTIVITIES / SECURITY -->
  <div class="subbar">ENTERTAINMENT, ACTIVITIES & SECURITY</div>
  <div class="block">
    <div class="row">
      <div class="cell label w55">14. ANY ENTERTAINMENT OTHER THAN BG MUSIC/KARAOKE/TRIVIA?</div>
      <div class="cell w5 center"><%= yn(data.entertainment_other) %></div>
      <div class="cell label w15">DETAILS</div>
      <div class="cell w25 wrap"><%= data.entertainment_details %></div>
    </div>
    <div class="row">
      <div class="cell label w55">15. OTHER RECREATIONAL ACTIVITIES (BEYOND LISTED)?</div>
      <div class="cell w5 center"><%= yn(data.recreational_activites) %></div>
      <div class="cell label w15">DETAILS</div>
      <div class="cell w25 wrap"><%= data.recreational_details %></div>
    </div>
    <div class="row">
      <div class="cell label w30">16. BOUNCERS / SECURITY STAFF?</div>
      <div class="cell w10 center"><%= yn(data.security_present) %></div>
      <div class="cell label w20">BACKGROUND CHECKS?</div>
      <div class="cell w10 center"><%= yn(background_checks) %></div>
      <div class="cell label w15">ARMED?</div>
      <div class="cell w5 center"><%= yn(security_armed) %></div>
      <div class="cell label w15">CONFLICT-RES TRAINED?</div>
      <div class="cell w5 center"><%= yn(security_trained) %></div>
    </div>
  </div>

  <!-- 17–18 DELIVERY / AUTO -->
  <div class="subbar">DELIVERY & AUTO</div>
  <div class="block">
    <div class="row">
      <div class="cell label w30">17. OFFER DELIVERY?</div>
      <div class="cell w10 center"><%= yn(data.delivery_offered) %></div>
      <div class="cell label w25">INSURED-OWNED AUTOS?</div>
      <div class="cell w10 center"><%= yn(del_insured_autos) %></div>
      <div class="cell label w15">EMPLOYEE AUTOS?</div>
      <div class="cell w10 center"><%= yn(del_employee_autos) %></div>
    </div>
    <div class="row">
      <div class="cell label w25">3RD-PARTY DELIVERY?</div>
      <div class="cell w10 center"><%= yn(del_third_party) %></div>
      <div class="cell label w35">DELIVERY SALES (INSURED/EMP AUTOS)</div>
      <div class="cell w15 right">$<%= money(del_sales_owned_emp) %></div>
      <div class="cell label w15">&gt;20% OF LOCATION SALES?</div>
      <div class="cell w10 center"><%= yn(del_pct_over_20) %></div>
    </div>
    <div class="row">
      <div class="cell label w20">IF YES, EXPLAIN</div>
      <div class="cell w80 wrap"><%= data.del_pct_explain %></div>
    </div>
    <div class="row">
      <div class="cell label w25">RADIUS &gt; 5 MILES?</div>
      <div class="cell w10 center"><%= yn(del_radius_gt5) %></div>
      <div class="cell label w20">IF YES, EXPLAIN</div>
      <div class="cell w45 wrap"><%= data.del_radius_explain %></div>
    </div>
    <div class="row">
      <div class="cell label w25">HOURS PAST 10 PM?</div>
      <div class="cell w10 center"><%= yn(del_after_10pm) %></div>
      <div class="cell label w20">IF YES, EXPLAIN</div>
      <div class="cell w45 wrap"><%= data.del_after_10pm_explain %></div>
    </div>
    <div class="row">
      <div class="cell label w45">18. IF AUTO COVERAGE IS RATED — SHUTTLE SERVICES?</div>
      <div class="cell w10 center"><%= yn(shuttle_services) %></div>
      <div class="cell label w15">IF YES, EXPLAIN</div>
      <div class="cell w30 wrap"><%= data.shuttle_explanation %></div>
    </div>
  </div>

  <!-- 19 LIQUOR -->
  <div class="subbar">LIQUOR VIOLATIONS</div>
  <div class="block">
    <div class="row">
      <div class="cell label w45">19. ANY LIQUOR LAW VIOLATIONS IN LAST 3 YEARS?</div>
      <div class="cell w10 center"><%= yn(data.liquor_lapse) %></div>
      <div class="cell label w15">IF YES, DESCRIBE</div>
      <div class="cell w30 wrap"><%= data.liquor_claims %></div>
    </div>
  </div>

  <!-- REMARKS -->
  <div class="subbar">REMARKS</div>
  <div class="block">
    <div class="row">
      <div class="cell w100 wrap" style="min-height:72px;"><%= data.remarks || "" %></div>
    </div>
  </div>

  <!-- AGENCY FOOTER -->
  <div class="block">
    <div class="row">
      <div class="cell label w20">AGENCY</div>
      <div class="cell w35 wrap"><%= defaults.agencyName %></div>
      <div class="cell label w10">CODE</div>
      <div class="cell w10"><%= defaults.agencyCode %></div>
      <div class="cell label w10">AGENT</div>
      <div class="cell w15"><%= defaults.agentName %></div>
    </div>
    <div class="row">
      <div class="cell label w20">EMAIL</div>
      <div class="cell w35"><%= defaults.agentEmail %></div>
      <div class="cell label w10">PHONE</div>
      <div class="cell w10"><%= defaults.agentPhone %></div>
      <div class="cell label w10">DATE</div>
      <div class="cell w15"><%= formatDate(dateShown) %></div>
    </div>
  </div>

  <div class="footnote">
    SPS-1 (10/2020) &nbsp;&nbsp; Page 1 of 2 &nbsp;&nbsp; Society Insurance — Supplemental.
  </div>
</div>

<!-- ====================== PAGE 2 (Overflow for long explanations) ====================== -->
<div class="page">
  <div class="headerbar">
    <div class="brand">SPS-1</div>
    <div class="title">
      <div class="line1"><%= defaults.programTitle %></div>
      <div class="line2">Continuation / Additional Details</div>
    </div>
  </div>

  <div class="subbar">ADDITIONAL DETAILS</div>
  <div class="block">
    <div class="row">
      <div class="cell label w30">OPENING PLAN DETAILS</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.open_60_days_details %></div>
    </div>
    <div class="row">
      <div class="cell label w30">PRIOR EXPERIENCE DETAILS</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.ownership_experience_details %></div>
    </div>
    <div class="row">
      <div class="cell label w30">ENTERTAINMENT DETAILS</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.entertainment_details %></div>
    </div>
    <div class="row">
      <div class="cell label w30">RECREATIONAL DETAILS</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.recreational_details %></div>
    </div>
    <div class="row">
      <div class="cell label w30">DELIVERY &gt;20% EXPLANATION</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.del_pct_explain %></div>
    </div>
    <div class="row">
      <div class="cell label w30">RADIUS &gt;5 MILES EXPLANATION</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.del_radius_explain %></div>
    </div>
    <div class="row">
      <div class="cell label w30">AFTER 10PM EXPLANATION</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.del_after_10pm_explain %></div>
    </div>
    <div class="row">
      <div class="cell label w30">SHUTTLE EXPLANATION</div>
      <div class="cell w70 wrap" style="min-height:50px;"><%= data.shuttle_explanation %></div>
    </div>
    <div class="row">
      <div class="cell label w30">SMOKER / GRILL — NOTES (CONT.)</div>
      <div class="cell w70 wrap" style="min-height:60px;"><%= data.smoker_notes %></div>
    </div>
  </div>

  <div class="footnote">
    SPS-1 (10/2020) &nbsp;&nbsp; Page 2 of 2 &nbsp;&nbsp; Society — Supplemental continuation.
  </div>
</div>

</body>
</html>
